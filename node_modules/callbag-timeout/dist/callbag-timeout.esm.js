function timeout(delay) {
  return function (source) {
    return function (start, sink) {
      if (start !== 0) return;
      var absoluteDelay = delay instanceof Date;
      var talkback;
      var timerId;

      function scheduleTimeout(ms) {
        timerId = setTimeout(function () {
          talkback(2);
          var err = new Error('Timeout.');
          err.code = 'TIMEOUT';
          sink(2, err);
        }, ms);
      }

      source(0, function (type, data) {
        if (type === 0) {
          talkback = data;
          scheduleTimeout(absoluteDelay ? delay - Date.now() : delay);
          sink(0, function (type, data) {
            if (type === 2) {
              clearTimeout(timerId);
            }

            talkback(type, data);
          });
          return;
        }

        if (type === 2) {
          clearTimeout(timerId);
        } else if (type === 1 && !absoluteDelay) {
          clearTimeout(timerId);
          scheduleTimeout(delay);
        }

        sink(type, data);
      });
    };
  };
}

export default timeout;
